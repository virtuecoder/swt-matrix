<project name="swt-matrix" default="local website" basedir=".">
	<property name="version" value="0.3" />
	<property name="local_website" value="c:\dev\wamp\www\netanel15" />

	<property name="db.username" value="root"/>
	<property name="db.password" value=""/>
	<property name="db.name" value="netanel15"/>
	<!-- The name of the database to backup. -->
	<property name="db.export.file" value="..\website\joomla-1.5.sql"/>
	<property name="mysqldump" value="C:\Dev\wamp\bin\mysql\mysql5.0.51a\bin\mysqldump"/>


	<target name="clean">
		<tstamp />
		<delete dir="." includes="*.jar" />
	</target>

	<target name="proguard/check">
	    <uptodate property="proguard.uptodate" targetfile="${ant.project.name}-${version}.jar">
	        <srcfiles dir="../src" includes="**/*"/>
	        <srcfiles dir="." includes="proguard.cfg"/>
	        <mapper type="merge" to="${ant.project.name}-${version}.jar"/>
	    </uptodate>
	    <echo message="${proguard.uptodate}"/>
	</target>

	<target name="jar" description="create the jar" depends="proguard/check" unless="proguard.uptodate">

		<!-- swt-matrix.jar-->
		<jar jarfile="${ant.project.name}.jar">
			<fileset dir="../bin">
				<include name="pl/netanel/swt/matrix/*.class" />
				<include name="pl/netanel/util/*.class" />
				<include name="../doc/EULA.txt" />
				<exclude name="**/*Test*.class" />
			</fileset>
			<!--fileset dir="${lib}" includes="**/*" /-->
			<manifest>
				<!--attribute name="Main-Class" value="app.DataMate" /-->
				<attribute name="Class-Path" value="." />
			</manifest>
		</jar>

		<!-- obfuscate and optimize by ProGuard -->
		<taskdef resource="proguard/ant/task.properties" 
			classpath="c:/dev/Java/java_lib/proguard4.3/lib/proguard.jar" />
		<proguard configuration="proguard.cfg"/>

		<rename src="obfuscated.${ant.project.name}.jar" dest="${ant.project.name}-${version}.jar"/>
		<rename src="out.map" dest="obfuscation-${version}.map"/>

		<touch file="proguard.done"/>

	</target>

	<target name="snippets">
		<zip destfile="${ant.project.name}-snippets-${version}.zip">
			<zipfileset dir="../src_demo" includes="pl/netanel/swt/matrix/snippets/*.java"/>
			<zipfileset dir=".." includes="*.png" />
		</zip>
	</target>

	
	<target name="javadoc/check">
      <uptodate property="javadoc.uptodate" targetfile="../javadoc/index.html">
          <srcfiles dir="../src"/>
      </uptodate>
	</target>
	
	<target name="javadoc" depends="javadoc/check" unless="javadoc.uptodate">
		<javadoc 
	      access="protected" 
	      author="false" 
	      sourcepath="../src"
	      excludepackagenames="pl.netanel.swt, pl.netanel.util, pl.netanel.swt.matrix.painter"
	      destdir="../javadoc"
	      splitindex="true" 
	      use="true" 
	      version="false" 
	      windowtitle="SWT Matrix - API javadoc" 
	      doctitle="SWT Matrix 0.01 API">

			<bottom>
				<![CDATA[<i>Copyright &#169; 2011 netanel. All Rights Reserved.</i>]]>
			</bottom>
  	</javadoc>
  	
  	<touch file="javadoc.done"/>
  </target>

<!--target name="mysql" description="update joomla backend">
  	<loadfile srcfile="${src.file}" property="${src.file.contents}">
  	  <filterchain>
  	    <filterreader classname="org.apache.tools.ant.filters.StripLineBreaks"/>
  	  </filterchain>
  	</loadfile>
  	
  	<echo file="snippets.sql">
  		update jos_content set introtext = "fasfas" where id = 11; 
      commit;
		</echo>
  	<sql 
  		  driver="com.mysql.jdbc.Driver"
  	    url="jdbc:mysql://localhost:3306/netanel15"
  	    userid="root"
  	    password=""
        classpath="C:\Dev\Java\java_lib\mysql-connector-java-5.1.8\mysql-connector-java-5.1.8-bin.jar"
  		  print="true"
  		  src="snippets.sql"
  		>
  	</sql>
  	
	</target-->
<target name="local website" depends="jar, javadoc, snippets">
	<sync todir="${local_website}\swt-matrix\snippets">
		<fileset dir="../src_demo/pl/netanel/swt/matrix/snippets"/>
	</sync>

	<sync todir="${local_website}\swt-matrix\javadoc">
		<fileset dir="../javadoc"/>
	</sync>
	
	<copy todir="${local_website}\swt-matrix">
		<fileset dir="../doc" includes="EULA.txt"/>
	</copy>

	<copy todir="${local_website}\swt-matrix" file="swt-matrix-${version}.jar" />
	<copy todir="${local_website}\swt-matrix" file="swt-matrix-snippets-${version}.zip" />

	<java classname="JoomlaMysqlUpdate" dir=".." fork="true">
		<classpath>
			<pathelement location="C:\Dev\Java\java_lib\mysql-connector-java-5.1.8\mysql-connector-java-5.1.8-bin.jar" />
			<pathelement path="../bin" />
		</classpath>
	</java>
	
  <replaceregexp file="${local_website}\media\system\js\netanel.js"
        match="var current_version = (.+);"
          replace='var current_version = "${version}";'
          byline="true" />


</target> 

<target name="backup" description="copy all project files to ftp site">
	<!-- Command to dump the database to *.sql file.-->
	<exec executable="${mysqldump}" output="${db.export.file}">
		<arg value="--extended-insert=false"/>
		<arg value="--complete-insert=true"/>
		<arg value="--add-drop-table"/>
		<arg value="--user=${db.username}"/>
		<arg value="--password=${db.password}"/>
		<arg value="${db.name}"/>
	</exec>

	<!-- zip the whole project directory including .git-->
	<zip destfile="matrix-project.zip"
      basedir=".."
      includes="**"
      excludes="build\matrix-project.zip"
    />

	<!-- ftp to backup  file to server -->
	<ftp 
       server="www.netanel.pl"
       remotedir="git"
       userid="u60772810"
       password="jackolo">

		<fileset dir=".\" includes="matrix-project.zip"/>
	</ftp>

	<delete file="matrix.zip"/>
</target>


<target name="publish" description="update the offical website" depends="local website">
	<ftp 
	  server="www.netanel.pl"
    remotedir="wsb6077281001"
    userid="u60772810"
	  password="jackolo"
	  depends="true"
		verbose="yes"
	>

		<fileset dir="${local_website}/swt-matrix"/>
		<fileset dir="${local_website}/templates"/>
		<fileset dir="${local_website}/media"/>
	</ftp>

</target>


</project>

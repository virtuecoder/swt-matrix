<!--
  The external dependencies are located in build.properties 
-->
<project name="swt-matrix" default="dist" basedir="..">
	<property file="build/build.properties" />
	<property file="build/version.properties" />
		
	<property name="output.dir" location="dist" />
	<property name="project.dir" location="${output.dir}/project" />

	<target name="clean">
		<tstamp />
		<delete dir="${output.dir}" /> 
	</target>

	<target name="-jar/check">
		<uptodate property="jar.uptodate" targetfile="${output.dir}/${ant.project.name}-${version}.jar">
			<srcfiles dir="src" includes="**/*" />
			<srcfiles dir="build" includes="build.xml" />
			<!--mapper type="merge" to="${ant.project.name}-${version}.jar"/-->
		</uptodate>
	</target>
	
	<!-- Assumes the java classes are already compiled in bin folder, 
	     which a default behavior when project is open in eclipse --> 
	<target name="jar" description="create the jar" depends="-jar/check" unless="jar.uptodate">
		<!-- Create jar -->
		<jar jarfile="${output.dir}\swt-matrix-dont-distribute.jar">
			<fileset dir="bin">
				<include name="pl/netanel/swt/matrix/*.class" />
				<include name="pl/netanel/swt/matrix/reloaded/*.class" />
				<include name="pl/netanel/swt/matrix/reloaded/ints/*.class" />
				<include name="pl/netanel/util/*.class" />
				<include name="../doc/EULA_v1.0.html" />
				<exclude name="**/*Test*.class" />
			</fileset>
			<manifest>
				<attribute name="Class-Path" value="." />
				<attribute name="Version" value="${version}" />
			</manifest>
		</jar>

		<!-- Obfuscate and optimize by ProGuard -->
		<taskdef resource="proguard/ant/task.properties" classpath="${proguard.dir}/proguard.jar" />
		<proguard>
			-libraryjars "${jdk.dir}\jre\lib\rt.jar"
			-libraryjars "${eclipse.swt.file}" 
			-libraryjars "${eclipse.swt.win32.file}"
			-injars       ${output.dir}\swt-matrix-dont-distribute.jar
			-outjars      ${output.dir}\${ant.project.name}-${version}.jar
			-printmapping ${output.dir}\obfuscation-${version}.map

			-dontoptimize
			-dontshrink

			-keepattributes Exceptions,InnerClasses,Signature,Deprecated,
			                SourceFile,LineNumberTable,*Annotation*,EnclosingMethod

			-keep public class * {
			    public protected *;
			}

			-keepclassmembers enum * {
			    public static **[] values();
			    public static ** valueOf(java.lang.String);
			}

			-keepclassmembers class * {
			    java.lang.Object clone();
			}

			-keepclassmembers class ** {
			    public static &lt;fields&gt;;
			}

			-keepnames class * implements java.io.Serializable

			-keepclassmembers class * implements java.io.Serializable {
			    static final long serialVersionUID;
			    private void writeObject(java.io.ObjectOutputStream);
			    private void readObject(java.io.ObjectInputStream);
			    java.lang.Object writeReplace();
			    java.lang.Object readResolve();
			    !transient &lt;fields&gt;;
			}
		</proguard>
	</target>
	
	<!-- Specify trace file in command line: -Dstack.trace=<your.file> -->
	<target name="retrace" depends="jar">
		<exec executable="java">
			<arg line="-jar ${proguard.dir}/retrace.jar ${output.dir}\obfuscation-${version}.map ${stack.trace}"/>
		</exec>
	</target>

	<target name="snippets">
		<zip destfile="${output.dir}/${ant.project.name}-snippets-${version}.zip">
			<zipfileset dir="src_demo" includes="pl/netanel/swt/matrix/snippets/*.java" />
		</zip>
	</target>


	<target name="-javadoc/check">
		<uptodate property="javadoc.uptodate" targetfile="${output.dir}/javadoc/index.html">
			<srcfiles dir="src" />
		</uptodate>
	</target>

	<target name="javadoc" depends="-javadoc/check" unless="javadoc.uptodate">
		<javadoc access="protected" author="false" sourcepath="src" 
			excludepackagenames="pl.netanel.swt, pl.netanel.util, pl.netanel.swt.matrix.custom" 
			destdir="${output.dir}/javadoc" splitindex="true" use="true" version="false" 
			windowtitle="SWT Matrix - API javadoc" doctitle="SWT Matrix ${version} API">

			<bottom>
				<![CDATA[<i>Copyright &#169; 2011 netanel.pl. All Rights Reserved.</i>]]>
			</bottom>
	</javadoc>

	<touch file="${output.dir}/javadoc/index.html/" />
</target>

<!-- Creates distribition of jar file allowed by EULA + public information --> 
<target name="dist" depends="clean, jar, javadoc, snippets">
	<zip destfile="${output.dir}/swt-matrix-${version}.zip">
		<!-- Binaries -->
		<fileset dir="${output.dir}" includes="swt-matrix-${version}.jar" />

		<!-- Docs -->
		<fileset dir="doc" includes="EULA_v1.0.html" />
		<fileset dir="doc" includes="Change-log.txt" />
		<zipfileset dir="${output.dir}/javadoc" prefix="javadoc" />

		<!-- Snippets -->
		<zipfileset dir="src_demo" includes="pl/netanel/swt/matrix/snippets/*.java" prefix="snippets" />
	</zip>
</target>

</project>

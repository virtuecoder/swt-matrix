<project name="swt-matrix" default="local website" basedir="..">
	<property file="build/local.properties" />
	<property file="build/version.properties" />
  
	<property name="output.dir" location="dist" />
  <property name="project.dir" location="${output.dir}/project" />

	
	<property name="jdk.dir" value="C:\Program Files\Java\jdk1.6.0_32" />
	<property name="java.lib.dir" value="D:\Dev\Java\java_lib" />
	<property name="eclipse.swt.file" value="D:\Dev\Java\eclipse\plugins\org.eclipse.swt_3.7.2.v3740f.jar" />
	<property name="eclipse.swt.win32.file" value="D:\Dev\Java\eclipse\plugins\org.eclipse.swt.win32.win32.x86_3.7.2.v3740f.jar" />
	<property name="wamp.dir" value="D:\dev\wamp" />
	<property name="local.website.dir" value="${wamp.dir}\www\netanel15" />

	<property name="db.username" value="root"/>
	<property name="db.password" value=""/>
	<property name="db.name" value="netanel15"/>
	<!-- The name of the database to backup. -->
	<property name="db.export.file" value="..\website\joomla-1.5.sql"/>
	<property name="mysqldump" value="${wamp.dir}\bin\mysql\mysql5.0.51a\bin\mysqldump"/>

	<target name="copyright">
	  <copy todir="../src.bak">
	    <fileset dir="../src"/>
	    <filterchain>
	      <concatfilter prepend="copyright.txt"/>
	    </filterchain>
	  </copy>
	  <copy todir="../src">
	    <fileset dir="../src.bak"/>
	  </copy>
	</target>
	
	<target name="remove-javadoc-tags">
		<replaceregexp byline="true">
		  <regexp pattern="@created"/>
		  <substitution expression="NewProperty=\1"/>
		  <fileset dir=".">
		    <include name="*.properties"/>
		  </fileset>
		</replaceregexp>
	</target>
	

	
	<target name="clean">
		<tstamp />
		<delete dir="." includes="*.jar" />
	</target>

	<target name="proguard/check">
	    <uptodate property="proguard.uptodate" targetfile="${ant.project.name}-${version}.jar">
	        <srcfiles dir="../src" includes="**/*"/>
	        <srcfiles dir="." includes="proguard.cfg"/>
	        <!--mapper type="merge" to="${ant.project.name}-${version}.jar"/-->
	    </uptodate>
	    <echo message="${proguard.uptodate}"/>
	</target>

	<target name="public-jar" description="create the jar" depends="proguard/check" unless="proguard.uptodate">
		<!-- swt-matrix.jar-->
		<jar jarfile="${output.dir}\swt-matrix-dont-distribute.jar">
			<fileset dir="bin">
				<include name="pl/netanel/swt/matrix/*.class" />
				<include name="pl/netanel/util/*.class" />
				<include name="../doc/EULA.txt" />
				<exclude name="**/*Test*.class" />
			</fileset>
			<manifest>
				<!--attribute name="Main-Class" value="app.DataMate" /-->
				<attribute name="Class-Path" value="." />
				<attribute name="Version" value="${version}" />
				<attribute name="Distribution" value="Public" />
			</manifest>
		</jar>
	</target>


<!--target name="mysql" description="update joomla backend">
  	<loadfile srcfile="${src.file}" property="${src.file.contents}">
  	  <filterchain>
  	    <filterreader classname="org.apache.tools.ant.filters.StripLineBreaks"/>
  	  </filterchain>
  	</loadfile>
  	
  	<echo file="snippets.sql">
  		update jos_content set introtext = "fasfas" where id = 11; 
      commit;
		</echo>
  	<sql 
  		  driver="com.mysql.jdbc.Driver"
  	    url="jdbd:mysql://localhost:3306/netanel15"
  	    userid="root"
  	    password=""
        classpath="c:\Dev\Java\java_lib\mysql-connector-java-5.1.8\mysql-connector-java-5.1.8-bin.jar"
  		  print="true"
  		  src="snippets.sql"
  		>
  	</sql>
  	
	</target-->
	
<target name="local website" depends="">
	<sync todir="${local.website.dir}\swt-matrix\snippets">
		<fileset dir="../src_demo/pl/netanel/swt/matrix/snippets"/>
	</sync>

	<sync todir="${local.website.dir}\swt-matrix\javadoc">
		<fileset dir="../javadoc"/>
	</sync>
	
	<!-- zip the whole project directory including .git-->
  <zip destfile="swt-matrix-javadoc-${version}.zip"
      basedir="../javadoc"
      includes="**"
    />
	
	<!-- zip the whole project directory including .git-->
  <zip destfile="swt-matrix-${version}.zip">
  	<zipfileset dir="../javadoc" prefix="javadoc"/>
  	<zipfileset dir="../src_demo" includes="pl/netanel/swt/matrix/snippets/*.java" prefix="snippets"/>
  	<zipfileset dir=".." includes="*.png" prefix="snippets"/>
  	<!--zipfileset dir="../src" includes="pl/netanel/swt/matrix/custom/*.java" prefix="custom"/-->
  	<zipfileset dir="." includes="swt-matrix-${version}.jar"/>
  	<!--zipfileset dir="." includes="swt-matrix-custom-${version}.jar"/-->
		<fileset dir="../doc" includes="EULA.txt"/>
		<fileset dir="../doc" includes="Change-log.txt"/>
  </zip>
	
	<copy todir="${local.website.dir}\swt-matrix">
		<fileset dir="../doc" includes="EULA.txt"/>
	</copy>
	
	<copy todir="${local.website.dir}\swt-matrix" file="swt-matrix-${version}.zip" />
	<copy todir="${local.website.dir}\swt-matrix" file="../doc/Change-log.txt" />

	<java classname="JoomlaMysqlUpdate" dir=".." fork="true">
		<classpath>
			<pathelement location="${java.lib.dir}\mysql-connector-java-5.1.8\mysql-connector-java-5.1.8-bin.jar" />
			<pathelement path="../bin" />
		</classpath>
	</java>
	
  <replaceregexp file="${local.website.dir}\media\system\js\netanel.js"
        match="var current_version = (.+);"
          replace='var current_version = "${version}";'
          byline="true" />
  </target> 

	
  <target name="export-project" description="for source code license">
    <mkdir dir="${project.dir}" />
    <copy tofile="${project.dir}/.project/" file=".project.dist" />
    <copy tofile="${project.dir}/.classpath" file=".classpath.dist"/>
    <copy todir="${project.dir}/src">
      <fileset dir="src">
        <!--exclude name="pl/netanel/swt/matrix/reloaded/**"/--> 
      </fileset>
    </copy>
    <copy todir="${project.dir}/src_demo">
      <fileset dir="src_demo">
        <include name="pl/netanel/swt/matrix/snippets/**"/> 
      </fileset>
    </copy>
    <copy todir="${project.dir}/build" file="build/build.xml"/>
    <copy todir="${project.dir}/build" file="build/build.properties"/>
    <copy todir="${project.dir}/build" file="build/version.properties"/>
    <copy todir="${project.dir}/doc" file="doc/EULA_v1.0.html"/>
    <copy todir="${project.dir}/doc" file="doc/Change-log.txt"/>
  
   	<!-- zip for distribution -->
    <zip destfile="${output.dir}/swt-matrix-src-${version}.zip"
        basedir="${project.dir}"
        includes="**/*" 
        defaultexcludes="no"/>
  
  </target>

	
	<target name="public-dist" depends="clean, public-jar">
		<ant antfile="build\build.xml" target="obfuscate"/>
		<ant antfile="build\build.xml" target="javadoc"/>
		<ant antfile="build\build.xml" target="snippets"/>
		
	  <zip destfile="swt-matrix-${version}.zip">
	    <!-- Binaries -->
	    <fileset dir="." includes="${output.dir}}/swt-matrix-${version}.jar" />

	    <!-- Docs -->
	    <fileset dir="doc" includes="EULA_v1.0.html" />
	    <fileset dir="doc" includes="Change-log.txt" />
	    <zipfileset dir="javadoc" prefix="javadoc" />

	    <!-- Snippets -->
	    <zipfileset dir="src_demo" includes="pl/netanel/swt/matrix/snippets/*.java" prefix="snippets" />

	    <!-- Project -->
	    <zipfileset dir="${output.dir}" includes="project/**.*" prefix="project" />

	  </zip>
	</target>

	
  <target name="backup" description="copy all project files to ftp site">
  	<!-- Command to dump the database to *.sql file.-->
  	<exec executable="${mysqldump}" output="${db.export.file}">
  		<arg value="--extended-insert=false"/>
  		<arg value="--complete-insert=true"/>
  		<arg value="--add-drop-table"/>
  		<arg value="--user=${db.username}"/>
  		<arg value="--password=${db.password}"/>
  		<arg value="${db.name}"/>
  	</exec>
  
  	<!-- zip the whole project directory including .git-->
  	<zip destfile="matrix-project.zip"
        basedir=".."
        includes="**" 
        defaultexcludes="no"
        excludes="build\matrix-project.zip">
  	 
  	  <fileset dir="." includes="examples*.zip"/>
  	</zip>
  
  	<!-- ftp to backup file to server -->
  	<ftp server="www.netanel.pl"
         remotedir="git"
         userid="${ftp.user}"
         password="${ftp.password}">
  
  		<fileset dir=".\" includes="matrix-project.zip"/>
  	</ftp>
  
  	<delete file="matrix.zip"/>
  </target>


  <target name="publish" description="update the offical website" depends="local website">
  	<ftp 
  	  server="www.netanel.pl"
      remotedir="ftp.remote.dir"
      userid="${ftp.username}"
  	  password="${ftp.password}"
  	  depends="true"
  		verbose="yes"
  	>
  		<fileset dir="${local.website.dir}/swt-matrix"/>
  		<fileset dir="${local.website.dir}/templates"/>
  		<fileset dir="${local.website.dir}/media"/>
  	</ftp>
  </target>
  
  <target name="build-872533850">
  	<ant antfile="build\build.xml" target="dist" />
  	<antcall target="export-project" />
    <ftp 
       server="${ftp.server}"
       remotedir="${ftp.remote.dir}/swt-matrix/872533850"
       userid="${ftp.username}"
       password="${ftp.password}"
       depends="true"
       verbose="yes"
     >
       <fileset file="${output.dir}/swt-matrix-${version}.zip"/>
       <fileset file="${output.dir}/swt-matrix-src-${version}.zip"/>
    </ftp>
  	<echo>The new version:
  	  http://www.netanel.pl/swt-matrix/872533850/swt-matrix-${version}.zip
  	  http://www.netanel.pl/swt-matrix/872533850/swt-matrix-src-${version}.zip</echo>
  	
	</target>

	<target name="dump-database">  
	    <exec executable="mysqldump.exe" dir="D:\Dev\wamp\bin\mysql\mysql5.5.24\bin" output="d:\database-dump.sql">  
	        <arg value="--user=dbo361399687" />  
	        <arg value="--password=jackolo" />  
	        <arg value="--host=db16.1and1.pl" />  
	        <arg value="--port=3306" />  
	        <arg value="db361399687" />  
	    </exec>  
	</target>

</project>
